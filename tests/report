# -*- mode: shell-script -*-

#src_file=../src/usr/local/sbin/swallow

# prefix_cmd="
# . /etc/shlib

# source '$src_file'

# logchunk -vvv next -c # }
# "

(
    cd "$test_tmpdir"
    mkdir test1
    cat <<EOF > test1/test.log
2023/02/26 01:28:08 [7384] receiving file list
2023/02/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438
2023/02/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635
2023/02/26 01:28:46 [7384] sent 544 bytes  received 149707 bytes  total size 9088521
EOF

)



try "logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" < \"$test_tmpdir/test1/test.log\" || exit 1
echo 'SELECT * FROM rsync_log;' | sqlite3 \"$test_tmpdir/test.db\" || exit 1
! [ -e \"$test_tmpdir/chunk.txt\" ] || {
   echo 'no chunk file expected' >&2
   exit 1
}
" \
    "simple chunk"
#is err "" NOCOLOR
is errlvl 0
is out "\
1|foo|1677374888|1677374926|303104|1073|9088521|149707|2|1
" NOCOLOR

try "
rm -f \"$test_tmpdir/chunk.txt\"
false | logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" || {
    echo 'failed logchunk' >&2
    [ -e \"$test_tmpdir/chunk.txt\" ] && {
       echo 'chunk file unexpected' >&2
       ls -al \"$test_tmpdir/chunk.txt\" >&2
       exit 14
    }
    exit 1
}
exit 13
" \
    "empty chunk"
is err "\
failed logchunk
" NOCOLOR
is errlvl 1
is out "" NOCOLOR

(
    cd "$test_tmpdir"
    mkdir -p test1
    cat <<EOF > test1/test.log
2023/02/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438
2023/02/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635
2023/02/26 01:28:46 [7384] sent 544 bytes  received 149707 bytes  total size 9088521
EOF
    rm -f chunk.txt

)


try "
logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" < \"$test_tmpdir/test1/test.log\" && exit 3
echo 'SELECT * FROM rsync_log;' | sqlite3 \"$test_tmpdir/test.db\" || exit 4
[ -e \"$test_tmpdir/chunk.txt\" ] || {
   echo 'chunk file expected' >&2
   exit 5
}
diff \"$test_tmpdir/test1/test.log\" \"$test_tmpdir/chunk.txt\" || exit 6
exit 8
" \
    "chunk with no first line"
is err "\
Error: (Line 1) Unexpected start line format:
  2023/02/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438

  Failed chunk is saved to \"$test_tmpdir/chunk.txt\"
" NOCOLOR
is errlvl 8
is out "\
1|foo|1677374888|1677374926|303104|1073|9088521|149707|2|1
" NOCOLOR


(
    cd "$test_tmpdir"
    mkdir -p test1
    ## This is 'Little-endian UTF-16 Unicode text, with no line terminators'
    printf "\xff\xfe\xfd" > test1/test.log
    rm -f chunk.txt

)


try "logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" < \"$test_tmpdir/test1/test.log\" && exit 3
echo 'SELECT * FROM rsync_log;' | sqlite3 \"$test_tmpdir/test.db\" || exit 4
[ -e \"$test_tmpdir/chunk.txt\" ] || {
   echo 'chunk file expected' >&2
   exit 5
}
diff -u \"$test_tmpdir/test1/test.log\" \"$test_tmpdir/chunk.txt\" || exit 6
exit 8
" \
    "chunk with non unicode data"
is err "\
Error: (Line 1) Invalid UTF-8 data [ff fe fd]:
  ���

  Failed chunk is saved to \"$test_tmpdir/chunk.txt\"
" NOCOLOR
is errlvl 8
is out "\
1|foo|1677374888|1677374926|303104|1073|9088521|149707|2|1
" NOCOLOR



(
    cd "$test_tmpdir"
    mkdir -p test1
    cat <<EOF > test1/test.log
2023/02/26 01:28:08 [7384] receiving file list
2023/02/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438
2023/02/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635
2023/02/26 01:28:46 [7384] sent 544 bytes  received 149707 bytes  total size 9088521
2023/02/26 01:28:46 [7384] spurious data
EOF
    rm -f chunk.txt

)


try "logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" < \"$test_tmpdir/test1/test.log\" && exit 3
echo 'SELECT * FROM rsync_log;' | sqlite3 \"$test_tmpdir/test.db\" || exit 4
[ -e \"$test_tmpdir/chunk.txt\" ] || {
   echo 'chunk file expected' >&2
   exit 5
}
diff -u \"$test_tmpdir/test1/test.log\" \"$test_tmpdir/chunk.txt\" || exit 6
exit 8
" \
    "chunk with data after last line"
is err "\
Error: (Line 5) Unexpected lines found after the end line:
  2023/02/26 01:28:46 [7384] spurious data

  Failed chunk is saved to \"$test_tmpdir/chunk.txt\"
" NOCOLOR
is errlvl 8
is out "\
1|foo|1677374888|1677374926|303104|1073|9088521|149707|2|1
" NOCOLOR



(
    cd "$test_tmpdir"
    mkdir -p test1
    cat <<EOF > test1/test.log
2023/13/26 01:28:08 [7384] receiving file list
2023/13/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438
2023/13/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635
2023/13/26 01:28:46 [7384] sent 544 bytes  received 149707 bytes  total size 9088521
EOF
    rm -f chunk.txt

)


try "logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" < \"$test_tmpdir/test1/test.log\" && exit 3
echo 'SELECT * FROM rsync_log;' | sqlite3 \"$test_tmpdir/test.db\" || exit 4
[ -e \"$test_tmpdir/chunk.txt\" ] || {
   echo 'chunk file expected' >&2
   exit 5
}
diff -u \"$test_tmpdir/test1/test.log\" \"$test_tmpdir/chunk.txt\" || exit 6
exit 8
" \
    "chunk with invalid date first line"
is err "\
Error: (Line 1) Failed to parse \"2023/13/26 01:28:08\" as a date (input is out of range) on first chunk line:
  2023/13/26 01:28:08 [7384] receiving file list

  Failed chunk is saved to \"$test_tmpdir/chunk.txt\"
" NOCOLOR
is errlvl 8
is out "\
1|foo|1677374888|1677374926|303104|1073|9088521|149707|2|1
" NOCOLOR


(
    cd "$test_tmpdir"
    mkdir -p test1
    cat <<EOF > test1/test.log
2023/12/26 01:28:08 [7384] receiving file list
2023/12/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438
2023/12/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635
2023/13/26 01:28:46 [7384] sent 544 bytes  received 149707 bytes  total size 9088521
EOF
    rm -f chunk.txt

)


try "logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" < \"$test_tmpdir/test1/test.log\" && exit 3
echo 'SELECT * FROM rsync_log;' | sqlite3 \"$test_tmpdir/test.db\" || exit 4
[ -e \"$test_tmpdir/chunk.txt\" ] || {
   echo 'chunk file expected' >&2
   exit 5
}
diff -u \"$test_tmpdir/test1/test.log\" \"$test_tmpdir/chunk.txt\" || exit 6
exit 8
" \
    "chunk with invalid date end line"
is err "\
Error: (Line 4) Failed to parse \"2023/13/26 01:28:46\" as a date (input is out of range) on last chunk line:
  2023/13/26 01:28:46 [7384] sent 544 bytes  received 149707 bytes  total size 9088521

  Failed chunk is saved to \"$test_tmpdir/chunk.txt\"
" NOCOLOR
is errlvl 8
is out "\
1|foo|1677374888|1677374926|303104|1073|9088521|149707|2|1
" NOCOLOR



(
    cd "$test_tmpdir"
    mkdir -p test1
    cat <<EOF > test1/test.log
2023/12/26 01:28:08 [7384] receiving file list
2023/12/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438
2023/12/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635
2023/12/26 01:28:46 [7384] sent 544 bytes  received 14423948723492837492834239487239707 bytes  total size 9088521
EOF
    rm -f chunk.txt

)


try "logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" < \"$test_tmpdir/test1/test.log\" && exit 3
echo 'SELECT * FROM rsync_log;' | sqlite3 \"$test_tmpdir/test.db\" || exit 4
[ -e \"$test_tmpdir/chunk.txt\" ] || {
   echo 'chunk file expected' >&2
   exit 5
}
diff -u \"$test_tmpdir/test1/test.log\" \"$test_tmpdir/chunk.txt\" || exit 6
exit 8
" \
    "chunk with invalid received count"
is err "\
Error: (Line 4) Failed to parse received count \"14423948723492837492834239487239707\" as an i64 integer (number too large to fit in target type) on last chunk line:
  2023/12/26 01:28:46 [7384] sent 544 bytes  received 14423948723492837492834239487239707 bytes  total size 9088521

  Failed chunk is saved to \"$test_tmpdir/chunk.txt\"
" NOCOLOR
is errlvl 8
is out "\
1|foo|1677374888|1677374926|303104|1073|9088521|149707|2|1
" NOCOLOR




(
    cd "$test_tmpdir"
    mkdir -p test1
    cat <<EOF > test1/test.log
2023/12/26 01:28:08 [7384] receiving file list
2023/12/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438
2023/12/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635
2023/12/26 01:28:46 [7384] sent 544 bytes  received 144239 bytes  total size 908852148723492837492834239487239707
EOF
    rm -f chunk.txt

)


try "logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" < \"$test_tmpdir/test1/test.log\" && exit 3
echo 'SELECT * FROM rsync_log;' | sqlite3 \"$test_tmpdir/test.db\" || exit 4
[ -e \"$test_tmpdir/chunk.txt\" ] || {
   echo 'chunk file expected' >&2
   exit 5
}
diff -u \"$test_tmpdir/test1/test.log\" \"$test_tmpdir/chunk.txt\" || exit 6
exit 8
" \
    "chunk with invalid total count"
is err "\
Error: (Line 4) Failed to parse total count \"908852148723492837492834239487239707\" as an i64 integer (number too large to fit in target type) on last chunk line:
  2023/12/26 01:28:46 [7384] sent 544 bytes  received 144239 bytes  total size 908852148723492837492834239487239707

  Failed chunk is saved to \"$test_tmpdir/chunk.txt\"
" NOCOLOR
is errlvl 8
is out "\
1|foo|1677374888|1677374926|303104|1073|9088521|149707|2|1
" NOCOLOR



(
    cd "$test_tmpdir"
    mkdir -p test1
    cat <<EOF > test1/test.log
2023/12/26 01:28:08 [7384] receiving file list
2023/12/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438
2023/12/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635
2023/12/26 01:28:36 [7384] >fX.t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635
2023/12/26 01:28:46 [7384] sent 544 bytes  received 144239 bytes  total size 908852148723492837492834239487239707
EOF
    rm -f chunk.txt

)


try "logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" < \"$test_tmpdir/test1/test.log\" && exit 3
echo 'SELECT * FROM rsync_log;' | sqlite3 \"$test_tmpdir/test.db\" || exit 4
[ -e \"$test_tmpdir/chunk.txt\" ] || {
   echo 'chunk file expected' >&2
   exit 5
}
diff -u \"$test_tmpdir/test1/test.log\" \"$test_tmpdir/chunk.txt\" || exit 6
exit 8
" \
    "chunk with unexpected log line format"
is err "\
Error: (Line 4) Unexpected log line format:
  2023/12/26 01:28:36 [7384] >fX.t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635

  Failed chunk is saved to \"$test_tmpdir/chunk.txt\"
" NOCOLOR
is errlvl 8
is out "\
1|foo|1677374888|1677374926|303104|1073|9088521|149707|2|1
" NOCOLOR



(
    cd "$test_tmpdir"
    mkdir -p test1
    cat <<EOF > test1/test.log
2023/12/26 01:28:08 [7384] receiving file list
2023/12/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438
2023/12/26 01:28:36 [7384] >f..t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635
EOF
    rm -f chunk.txt

)

try "logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" < \"$test_tmpdir/test1/test.log\" || exit 3
echo 'SELECT * FROM rsync_log;' | sqlite3 \"$test_tmpdir/test.db\" || exit 4
[ -e \"$test_tmpdir/chunk.txt\" ] && {
   echo 'chunk file unexpected' >&2
   exit 5
}
exit 8
" \
    "chunk with no end"
is err "\
I logchunk.import: Log inserted into the database successfully.
" NOCOLOR
is errlvl 8
is out "\
1|foo|1677374888|1677374926|303104|1073|9088521|149707|2|1
2|foo|1703554088|1703554116|303104|1073|0|0|2|0
" NOCOLOR



(
    cd "$test_tmpdir"
    mkdir -p test1
    cat <<EOF > test1/test.log
2023/12/26 01:28:08 [810] receiving file list
2023/12/26 01:28:36 [811] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438
2023/12/26 01:28:36 [810] >f..t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635
EOF
    rm -f chunk.txt

)

try "logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" < \"$test_tmpdir/test1/test.log\" && exit 3
echo 'SELECT * FROM rsync_log;' | sqlite3 \"$test_tmpdir/test.db\" || exit 4
[ -e \"$test_tmpdir/chunk.txt\" ] || {
   echo 'chunk file expected' >&2
   exit 5
}
diff -u \"$test_tmpdir/test1/test.log\" \"$test_tmpdir/chunk.txt\" || exit 6
exit 8
" \
    "chunk with pid mismatch"
is err "\
Error: (Line 2) Unexpected PID change from 810 to 811 on file change line:
  2023/12/26 01:28:36 [811] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438

  Failed chunk is saved to \"$test_tmpdir/chunk.txt\"
" NOCOLOR
is errlvl 8
is out "\
1|foo|1677374888|1677374926|303104|1073|9088521|149707|2|1
2|foo|1703554088|1703554116|303104|1073|0|0|2|0
" NOCOLOR



(
    cd "$test_tmpdir"
    mkdir -p test1
    cat <<EOF > test1/test.log
2023/12/26 01:28:08 [810] receiving file list
2023/04/24 14:27:18 [810] cL+++++++++ recv home/vaab/.config/Rocket.Chat/SS 37 0
2023/12/26 01:28:36 [810] >f..t...... recv .config/https%3A/chat.kal.fr/GPUCache/data_1 270336 438
2023/12/26 01:28:36 [810] >f..t...... recv .config/https%3A/chat.lokavaluto.fr/Cookies 32768 635
2023/04/24 14:39:55 [810] cLc.t...... recv home/vaab/.thunderbird/ybdenv7w.default-release/lock 18 0
2023/04/24 14:27:18 [810] .d..t...... recv home/vaab/.config/Rocket.Chat 450 0
2023/12/26 01:28:46 [810] sent 544 bytes  received 144239 bytes  total size 90885214872349
EOF
    rm -f chunk.txt

)

try "logchunk -vvv import \"$test_tmpdir/test.db\" foo \"$test_tmpdir/chunk.txt\" < \"$test_tmpdir/test1/test.log\" || exit 3
echo 'SELECT * FROM rsync_log;' | sqlite3 \"$test_tmpdir/test.db\" || exit 4
[ -e \"$test_tmpdir/chunk.txt\" ] && {
   echo 'chunk file unexpected' >&2
   exit 5
}
exit 8
" \
    "chunk with different type of lines"
is err "\
I logchunk.import: Log inserted into the database successfully.
" NOCOLOR
is errlvl 8
is out "\
1|foo|1677374888|1677374926|303104|1073|9088521|149707|2|1
2|foo|1703554088|1703554116|303104|1073|0|0|2|0
3|foo|1703554088|1703554126|303609|1073|90885214872349|144239|5|1
" NOCOLOR
